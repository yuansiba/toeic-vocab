<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç›Šå–®å­—</title>
    <style>
        :root {
            --primary: #4a90e2;
            --secondary: #f39c12;
            --success: #27ae60;
            --danger: #e74c3c;
            --bg: #f5f7fa;
            --card: #ffffff;
            --text: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text);
        }

        .container { max-width: 800px; width: 100%; }
        h1 { color: var(--primary); text-align: center; margin-bottom: 20px; }

        /* å°èˆªåˆ†é  */
        .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { 
            padding: 10px 15px; border: none; border-radius: 20px; 
            cursor: pointer; font-size: 15px; transition: 0.3s; 
            background: #e0e0e0; color: #555; font-weight: bold;
        }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3); }
        .tab-btn.manage { background: #34495e; color: white; }

        /* ç¯©é¸å€ */
        .filter-section { 
            background: white; padding: 15px; border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        select, button.action-btn { padding: 8px 12px; font-size: 15px; border-radius: 5px; border: 1px solid #ddd; }
        
        /* é€šç”¨ */
        .hidden { display: none !important; }
        .feedback-text { font-weight: bold; min-height: 24px; margin-top: 10px; }
        .nav-controls { margin-top: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .nav-btn { background: white; border: 1px solid #ccc; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        
        /* è·³è½‰é¸å–®æ¨£å¼å„ªåŒ– */
        .jump-container { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .jump-select { 
            max-width: 200px; padding: 5px; border-radius: 5px; border: 1px solid #ddd; 
            font-size: 13px; color: #666; cursor: pointer; background: #fff;
        }
        /* é»é¸æ™‚è®“æ–‡å­—è®Šæ·±ï¼Œå¢åŠ è¾¨è­˜åº¦ */
        .jump-select:focus { border-color: var(--primary); color: #333; }

        /* 1. åˆ—è¡¨æ¨¡å¼ */
        #list-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .vocab-item {
            background: var(--card); padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
            border-left: 5px solid transparent; transition: 0.3s; position: relative;
        }
        .vocab-item.marked { border-left-color: var(--secondary); background: #fffcf5; }
        .vocab-item.custom { border-left-color: #9b59b6; }
        .word-info b { font-size: 18px; color: var(--primary); display: block; }
        .word-info span { font-size: 14px; color: #666; }
        .star-btn { font-size: 24px; cursor: pointer; background: none; border: none; color: #ccc; transition: 0.2s; }
        .vocab-item.marked .star-btn, .learning-card.marked .star-btn { color: var(--secondary); transform: scale(1.2); }
        .del-btn { color: #e74c3c; font-size: 12px; cursor: pointer; margin-left: 10px; border: 1px solid #e74c3c; padding: 2px 5px; border-radius: 4px; background: white; }

        /* 2. å–®å­—å¡ (å­¸ç¿’æ¨¡å¼) */
        #learning-view { display: none; text-align: center; }
        .learning-card {
            background: white; padding: 40px 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto;
            position: relative; border-top: 5px solid var(--primary);
        }
        .learning-card.marked { border-top-color: var(--secondary); background: #fffcf5; }
        .learn-word { font-size: 48px; font-weight: bold; color: var(--text); margin: 10px 0; line-height: 1.2; }
        .learn-def {
    font-size: 35px;          /* ä¸­æ–‡ç¨å¾®å¤§ä¸€é»ï¼Œé–±è®€æ›´èˆ’æœ */
    color: #2c3e50;           /* æ·±è‰²ï¼Œå’Œè‹±æ–‡ä¸€è‡´ */
    margin-top: 10px;            /* ä¸éœ€è¦å¾€ä¸‹æ¨ */
    border-top: none;         /* âœ… ç§»é™¤é‚£æ¢ç·š */
    padding-top: 0;           /* âœ… ç§»é™¤ç·šç•™ä¸‹çš„ç©ºç™½ */
    text-align: center;
}

        .card-star-pos { position: absolute; top: 15px; right: 20px; font-size: 32px; }
        .big-play-btn { 
            background: #e1f0ff; color: var(--primary); border: none; width: 60px; height: 60px; 
            border-radius: 50%; font-size: 24px; cursor: pointer; margin-top: 20px; transition: 0.2s;
        }
        .big-play-btn:hover { background: var(--primary); color: white; }

        /* âœ… å–®å­—å¡ç¿»å¡ï¼ˆlearning-viewï¼‰ */
.learning-card { 
    perspective: 1200px;
}

.learn-flip {
    position: relative;
    width: 100%;
    min-height: 220px;
    transform-style: preserve-3d;
    transition: transform 0.6s;
    cursor: pointer;
}

.learn-flip.flipped {
    transform: rotateY(180deg);
}

.learn-face {
    position: absolute;
    inset: 0;
    backface-visibility: hidden;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
}

.learn-back {
    transform: rotateY(180deg);
}

.learn-hint {
    margin-top: 10px;
    font-size: 13px;
    color: #999;
}

/* é¿å…é»åˆ°æŒ‰éˆ•ä¹Ÿç¿»å¡ï¼ˆæŒ‰éˆ•ä»å¯é»ï¼‰ */
.learning-card button { cursor: pointer; }


        /* 3. ç™¼éŸ³ç·´ç¿’ (ç¿»å¡) */
        #flashcard-view { display: none; text-align: center; perspective: 1000px; }
        .flashcard {
            width: 320px; height: 240px; margin: 0 auto; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: white; padding: 20px; box-sizing: border-box; border: 2px solid #eee;
        }
        .card-front h2 { font-size: 32px; margin: 0 0 10px 0; color: var(--text); }
        .card-back { transform: rotateY(180deg); background: var(--primary); color: white; }
        .card-back p { font-size: 24px; margin: 0; }
        .mic-btn {
            background: #fff; border: 2px solid var(--primary); color: var(--primary);
            width: 60px; height: 60px; border-radius: 50%; font-size: 24px;
            display: flex; align-items: center; justify-content: center; margin: 20px auto 10px; cursor: pointer;
        }
        .mic-btn.recording { background: var(--danger); color: white; border-color: var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.7); } 70% { box-shadow: 0 0 0 15px rgba(231,76,60,0); } 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0); } }

        /* 4. æ¸¬é©—æ¨¡å¼ */
        #quiz-view { display: none; background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .quiz-question { font-size: 28px; font-weight: bold; margin-bottom: 20px; color: var(--primary); }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn { background: #f8f9fa; border: 2px solid #e9ecef; padding: 15px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .option-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .option-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); }

        /* 5. æ‹¼å­—æ¨¡å¼ (å„ªåŒ–ç‰ˆ) */
        #spelling-view { display: none; text-align: center; background: white; padding: 30px 30px 40px 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* é ‚éƒ¨å·¥å…·åˆ—ï¼šå°‡æ¨¡å¼èˆ‡è·³è½‰é¸å–®ä¸¦æ’ï¼Œç¸®å°å­—é«” */
        .spelling-top-bar {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px;
            margin-bottom: 30px; /* èˆ‡ä¸‹æ–¹å…§å®¹æ‹‰é–‹è·é›¢ */
            opacity: 0.7; transition: opacity 0.3s;
        }
        .spelling-top-bar:hover { opacity: 1; } /* æ»‘é¼ ç§»éå»æ‰è®Šæ¸…æ¥š */

        /* æ¨¡å¼é¸æ“‡å™¨ï¼šæ¥µç°¡åŒ– */
        .mode-selector { display: inline-flex; gap: 5px; background: none; padding: 0; }
        .mode-label { 
            padding: 4px 10px; cursor: pointer; border-radius: 15px; transition: 0.3s; 
            font-size: 13px; color: #888; border: 1px solid transparent;
        }
        .mode-label input { display: none; }
        .mode-label:has(input:checked) { 
            background: #f0f7ff; color: var(--primary); border-color: #d0e3ff; font-weight: bold;
        }

        .spelling-input { 
            font-size: 28px; padding: 10px; width: 80%; text-align: center; letter-spacing: 2px; 
            border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; outline: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .spelling-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(74,144,226,0.1); }
        .spelling-input.correct { border-color: var(--success); color: var(--success); background: #e8f8f5; }
        .spelling-input.wrong { border-color: var(--danger); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        
        .hint-display { min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 25px; }
        .hint-word { font-size: 40px; font-weight: bold; color: var(--primary); margin: 0 0 5px 0; }
        .hint-def { font-size: 28px; color: #333; margin: 0; font-weight: bold; }
        .hint-sub { font-size: 18px; color: #777; margin: 0; }

        /* 6. ç®¡ç†æ¨¡å¼ */
        #manage-view { display: none; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-group input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; min-width: 120px; }
        .add-btn { background: var(--success); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .bulk-section { margin-top: 30px; border-top: 2px dashed #eee; padding-top: 20px; }
        .bulk-textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 14px; resize: vertical; box-sizing: border-box; }
        .bulk-actions { margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px; }

        .custom-list { margin-top: 20px; max-height: 300px; overflow-y: auto; border-top: 1px solid #eee; }
        .custom-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }

    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ å¤šç›Šå–®å­—å…¨æ–¹ä½è¨“ç·´</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchMode('list')" id="tab-list">ğŸ“š å–®å­—æ¸…å–®</button>
        <button class="tab-btn" onclick="switchMode('learning')" id="tab-learning">ğŸ“‡ å–®å­—å¡</button>
        <button class="tab-btn" onclick="switchMode('flashcard')" id="tab-flashcard">ğŸ—£ï¸ ç™¼éŸ³ç·´ç¿’</button>
        <button class="tab-btn" onclick="switchMode('quiz')" id="tab-quiz">ğŸ“ è‡ªæˆ‘æ¸¬é©—</button>
        <button class="tab-btn" onclick="switchMode('spelling')" id="tab-spelling">âŒ¨ï¸ æ‹¼å­—ç‰¹è¨“</button>
        <button class="tab-btn manage" onclick="switchMode('manage')" id="tab-manage">âš™ï¸ è³‡æ–™ç®¡ç†</button>
    </div>

    <div class="filter-section" id="filter-bar">
        <div>
            <label>ç¯©é¸ç¯„åœï¼š</label>
            <select id="page-filter" onchange="filterData()">
                <option value="all"> å…¨éƒ¨å–®å­—</option>
                <option value="custom"> æˆ‘æ–°å¢çš„å–®å­—</option>
                <option value="marked">â­ æ¨™è¨˜</option>
                <option value="wrong">âŒ ç­”éŒ¯çš„é¡Œç›®</option>
                <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                <optgroup label="æˆ‘çš„åˆ†é¡" id="category-options"></optgroup>
                <option value="Page 1">Page 1</option>
                <option value="Page 2">Page 2</option>
                <option value="Page 3">Page 3</option>
                <option value="Page 5">Page 5</option>
                <option value="Page 6">Page 6</option>
                <option value="Page 7">Page 7</option>
            </select>
        </div>
        <div id="stats-info" style="font-size:14px; color:#666;"></div>
    </div>

    <!-- 1. åˆ—è¡¨æ¨¡å¼ -->
    <div id="list-view"></div>

    <!-- 2. å–®å­—å¡ (å­¸ç¿’æ¨¡å¼) -->
    <div id="learning-view">
        <div class="jump-container" style="margin-bottom:15px;">
            <label style="font-size:14px; color:#666;">è·³è½‰ï¼š</label>
            <select id="learning-jump" class="jump-select"></select>
        </div>

<div class="learning-card" id="learn-card-container" onclick="toggleLearnFlip()">
    <button class="star-btn card-star-pos" id="learn-star-btn" onclick="event.stopPropagation(); toggleMarkCurrent();">â˜†</button>

    <div class="learn-flip" id="learn-flip">
        <!-- æ­£é¢ï¼šè‹±æ–‡ -->
        <div class="learn-face learn-front">
            <div class="learn-word" id="learn-word">Word</div>
        </div>

        <!-- èƒŒé¢ï¼šä¸­æ–‡ -->
        <div class="learn-face learn-back">
            <div class="learn-def" id="learn-def">Definition</div>
        </div>
    </div>

    <button class="big-play-btn" onclick="event.stopPropagation(); speakCurrentCard();">ğŸ”Š</button>
</div>


        <div class="nav-controls">
            <button class="nav-btn" onclick="prevCard()">â¬…ï¸ ä¸Šä¸€å€‹</button>
            <span id="learn-progress" style="margin: 0 10px; color:#666; display:flex; align-items:center;">1/10</span>
            <button class="nav-btn" onclick="nextCard()">ä¸‹ä¸€å€‹ â¡ï¸</button>
        </div>
    </div>

    <!-- 3. ç™¼éŸ³ç·´ç¿’ (ç¿»å¡) -->
    <div id="flashcard-view">
        <div class="jump-container" style="margin-bottom:15px;">
            <label style="font-size:14px; color:#666;">è·³è½‰ï¼š</label>
            <select id="flashcard-jump" class="jump-select"></select>
        </div>
        
        <div class="flashcard" id="main-card" onclick="this.classList.toggle('flipped')">
            <div class="card-face card-front">
                <h2 id="card-word">Word</h2>
                <p id="card-def-hint" style="color:#aaa; font-size:16px;">(ä¸­æ–‡æç¤º)</p>
            </div>
            <div class="card-face card-back">
                <p id="card-def">å®šç¾©</p>
            </div>
        </div>
        <button id="mic-btn" class="mic-btn" onclick="startRecognition()">ğŸ¤</button>
        <div id="speech-feedback" class="feedback-text">é»æ“Šéº¥å…‹é¢¨å¾Œè®€å‡ºå–®å­—</div>
        <div class="nav-controls">
            <button class="nav-btn" onclick="prevCard()">â¬…ï¸ ä¸Šä¸€å€‹</button>
            <button class="nav-btn" onclick="speakCurrentCard()" style="background:var(--secondary); color:white; border:none;">ğŸ”Š è½ç™¼éŸ³</button>
            <button class="nav-btn" onclick="nextCard()">ä¸‹ä¸€å€‹ â¡ï¸</button>
        </div>
        <p id="card-progress" style="margin-top:10px; color:#888;"></p>
    </div>

    <!-- 4. æ¸¬é©—æ¨¡å¼ -->
    <div id="quiz-view">
        <div class="quiz-question" id="q-text">Question</div>
        <div class="quiz-options" id="q-options"></div>
        <p id="quiz-feedback" class="feedback-text"></p>
        <button onclick="nextQuiz()" id="next-quiz-btn" class="hidden nav-btn" style="background:var(--primary); color:white; margin-top:20px;">ä¸‹ä¸€é¡Œ â¡ï¸</button>
    </div>

    <!-- 5. æ‹¼å­—æ¨¡å¼ (å„ªåŒ–ç‰ˆ) -->
    <div id="spelling-view">
        <!-- é ‚éƒ¨å·¥å…·åˆ— -->
        <div class="spelling-top-bar">
            <!-- æ¨¡å¼é¸æ“‡ -->
            <div class="mode-selector">
                <label class="mode-label">
                    <input type="radio" name="spellMode" value="hard" checked onchange="changeSpellMode('hard')">
                    èƒŒèª¦
                </label>
                <label class="mode-label">
                    <input type="radio" name="spellMode" value="easy" onchange="changeSpellMode('easy')">
                    è·Ÿæ‰“
                </label>
            </div>

            <!-- è·³è½‰é¸å–® -->
            <div class="jump-container">
                <label style="font-size:13px; color:#999;">|</label> <!-- åˆ†éš”ç·š -->
                <select id="spelling-jump" class="jump-select"></select>
            </div>
        </div>
        
        <div class="hint-display" id="spell-display-area">
            <!-- å…§å®¹å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <input type="text" id="spell-input" class="spelling-input" placeholder="Type here..." autocomplete="off">
        <div id="spell-feedback" class="feedback-text"></div>
        <div style="margin-top:20px;">
            <button class="nav-btn" onclick="speakCurrentSpellWord()">ğŸ”Š æç¤ºéŸ³</button>
            <button class="nav-btn" style="background:var(--primary); color:white; border:none;" onclick="checkSpelling()">é€å‡º (Enter)</button>
            <button class="nav-btn" onclick="skipSpelling()" style="color:#666;">è·³é</button>
        </div>
    </div>

    <!-- 6. ç®¡ç†æ¨¡å¼ -->
    <div id="manage-view">
        <h2 style="color:#333; margin-top:0;">âœ¨ æ–°å¢å–®å­—</h2>
        <div class="input-group">
            <input type="text" id="new-word" placeholder="è‹±æ–‡å–®å­— (å¦‚: apple)" />
            <input type="text" id="new-def" placeholder="ä¸­æ–‡è§£é‡‹ (å¦‚: è˜‹æœ)" />
            <!-- åˆ†é¡ï¼šå¯é¸æ—¢æœ‰æˆ–è¼¸å…¥æ–°åˆ†é¡ -->
    <select id="new-cat-select" style="padding:10px; border:1px solid #ddd; border-radius:5px; min-width:160px;">
        <option value="">ï¼ˆä¸åˆ†é¡ï¼‰</option>
    </select>
    <input type="text" id="new-cat-input" placeholder="æˆ–è¼¸å…¥æ–°åˆ†é¡ (å¦‚: é¢è©¦)" style="min-width:160px;" />    
            <button class="add-btn" onclick="addCustomWord()">ï¼‹ åŠ å…¥</button>
        </div>
        <div class="bulk-section">
            <h3 style="margin-bottom:10px;">ğŸ“¦ æ‰¹é‡åŒ¯å…¥</h3>
            <p style="font-size:13px; color:#666; margin:0 0 5px 0;">ç›´æ¥è²¼ä¸Šæ¸…å–®ï¼Œç³»çµ±æœƒè‡ªå‹•éæ¿¾é»é»ã€æ©«ç·šç­‰ç¬¦è™Ÿ</p>
            <textarea id="bulk-input" class="bulk-textarea" placeholder="â€¢ apple å£“åŠ›è˜‹æœ
â€¢ banana é¦™è•‰"></textarea>
            <div class="bulk-actions">
                <button onclick="document.getElementById('bulk-input').value=''" class="nav-btn">æ¸…ç©º</button>
                <button onclick="batchImport()" class="add-btn" style="background:var(--primary);">æ‰¹æ¬¡åŠ å…¥</button>
            </div>
        </div>
        <h3 style="margin-top:30px;">æˆ‘æ–°å¢çš„å–®å­—åˆ—è¡¨ï¼š</h3>
        <div id="custom-word-list" class="custom-list">
            <p style="color:#999; text-align:center;">ç›®å‰æ²’æœ‰è‡ªè¨‚å–®å­—</p>
        </div>
        <button onclick="clearCustomWords()" style="margin-top:20px; background:#e74c3c; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">âš ï¸ æ¸…é™¤æ‰€æœ‰è‡ªè¨‚å–®å­—</button>
    </div>
</div>

<script>
    // ===== æ¨™æº–è‹±æ–‡ç™¼éŸ³ï¼ˆå…¨åŸŸé–å®šï¼‰=====
let STANDARD_VOICE = null;

function loadStandardVoice() {
  const voices = speechSynthesis.getVoices();

  // å„ªå…ˆé †åºï¼šGoogle â†’ Apple â†’ Microsoftï¼ˆå…¨éƒ¨ en-USï¼‰
  STANDARD_VOICE =
    voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) ||
    voices.find(v => v.lang === 'en-US' && v.name.includes('Samantha')) ||
    voices.find(v => v.lang === 'en-US' && v.name.includes('Alex')) ||
    voices.find(v => v.lang === 'en-US' && v.name.includes('Microsoft')) ||
    voices.find(v => v.lang === 'en-US') ||
    null;
}

// æŸäº›ç€è¦½å™¨ï¼ˆå°¤å…¶ iPhoneï¼‰è¦ç­‰ voices ready
speechSynthesis.onvoiceschanged = loadStandardVoice;
loadStandardVoice();

    let markedSet = new Set();

    // åŸå§‹è³‡æ–™
    const defaultData = [
        {p: "Page 1", w: "abandon", d: "æ”¾æ£„ *quit/discard"}, {p: "Page 1", w: "pressure", d: "å£“åŠ›"}, {p: "Page 1", w: "manager", d: "ç¶“ç†"}, {p: "Page 1", w: "ability", d: "èƒ½åŠ›"}, {p: "Page 1", w: "president", d: "ç¸½çµ±"}, {p: "Page 1", w: "doubt", d: "æ‡·ç–‘"}, {p: "Page 1", w: "able", d: "æœ‰èƒ½åŠ›çš„ *capable"}, {p: "Page 1", w: "fulfill", d: "å¯¦ç¾"}, {p: "Page 1", w: "task", d: "ä»»å‹™"}, {p: "Page 1", w: "abounding", d: "è±å¯Œçš„ *abundant"}, {p: "Page 1", w: "applicant", d: "æ±‚è·è€…"}, {p: "Page 1", w: "experience", d: "ç¶“é©—"}, {p: "Page 1", w: "truth", d: "äº‹å¯¦"}, {p: "Page 1", w: "above", d: "åœ¨â€¦ä¸Šé¢/è¶…é"}, {p: "Page 1", w: "abroad", d: "åœ¨åœ‹å¤– *overseas"}, {p: "Page 1", w: "absent", d: "ç¼ºå¸­çš„"}, {p: "Page 1", w: "absorb", d: "å¸æ”¶"}, {p: "Page 1", w: "assistant", d: "åŠ©ç†"}, {p: "Page 1", w: "accent", d: "å£éŸ³"}, {p: "Page 1", w: "accept", d: "æ¥å—"}, {p: "Page 1", w: "secretary", d: "ç§˜æ›¸"}, {p: "Page 1", w: "persuade", d: "èªªæœ"}, {p: "Page 1", w: "general", d: "ä¸€èˆ¬"}, {p: "Page 1", w: "receive", d: "æ¥å—"}, {p: "Page 1", w: "acceptance", d: "æ¥ç´"}, {p: "Page 1", w: "receipt", d: "æ”¶æ“š"}, {p: "Page 1", w: "corporate", d: "å…¬å¸"}, {p: "Page 1", w: "accident", d: "äº‹æ•… *mishap"}, {p: "Page 1", w: "deeply", d: "æ·±æ·±åœ°"}, {p: "Page 1", w: "concern", d: "æ“”å¿ƒ"}, {p: "Page 1", w: "cancer", d: "ç™Œç—‡"}, {p: "Page 1", w: "confirm", d: "ç¢ºèª"}, {p: "Page 1", w: "accord", d: "ç¬¦åˆã€ä¸€è‡´"}, {p: "Page 1", w: "conduct", d: "è¡Œç‚º"}, {p: "Page 1", w: "accountant", d: "æœƒè¨ˆå¸«"},
        {p: "Page 2", w: "interview", d: "é¢è©¦"}, {p: "Page 2", w: "participate", d: "åƒèˆ‡"}, {p: "Page 2", w: "accurate", d: "ç²¾ç¢ºçš„"}, {p: "Page 2", w: "significance", d: "é‡è¦æ€§"}, {p: "Page 2", w: "accuse", d: "æŒ‡æ§"}, {p: "Page 2", w: "fraud", d: "è©é¨™"}, {p: "Page 2", w: "chief", d: "ä¸»è¦çš„"}, {p: "Page 2", w: "anguish", d: "ç—›è‹¦ *pain"}, {p: "Page 2", w: "achieve", d: "é”åˆ° *accomplish"}, {p: "Page 2", w: "elect", d: "é¸èˆ‰"}, {p: "Page 2", w: "achievement", d: "æˆå°±"}, {p: "Page 2", w: "act", d: "è¡Œå‹•/è¡Œç‚º *carry out"}, {p: "Page 2", w: "principal", d: "(adj)ä¸»è¦çš„(n)æ ¡é•·"},{p: "Page 2", w: "principle", d: "åŸå‰‡"}, {p: "Page 2", w: "emphasize", d: "å¼·èª¿"}, {p: "Page 2", w: "activity", d: "æ´»å‹•"}, {p: "Page 2", w: "active", d: "ç©æ¥µçš„ *positive"}, {p: "Page 2", w: "discussion", d: "è¨è«–"}, {p: "Page 2", w: "summing up", d: "ç¸½çµ"}, {p: "Page 2", w: "economic", d: "ç¶“æ¿Ÿçš„"}, {p: "Page 2", w: "actor/actress", d: "æ¼”å“¡"}, {p: "Page 2", w: "actual", d: "å¯¦éš›çš„"}, {p: "Page 2", w: "accordance", d: "ä¸€è‡´"}, {p: "Page 2", w: "performer", d: "è¡¨æ¼”è€… *entertainer"}, {p: "Page 2", w: "actually", d: "å…¶å¯¦ã€å¯¦éš›ä¸Š *really"}, {p: "Page 2", w: "adopt", d: "æ¡ç”¨"}, {p: "Page 2", w: "adapt (to)", d: "é©æ‡‰"}, {p: "Page 2", w: "environment", d: "ç’°å¢ƒ"}, {p: "Page 2", w: "salary", d: "è–ªæ°´"}, {p: "Page 2", w: "increase", d: "å¢åŠ "}, {p: "Page 2", w: "add", d: "åŠ å…¥"}, {p: "Page 2", w: "address", d: "æ¼”è¬›ã€åœ°å€"}, {p: "Page 2", w: "admire", d: "æ¬£è³ *envy"}, {p: "Page 2", w: "honesty", d: "èª å¯¦"}, {p: "Page 2", w: "admit", d: "æ‰¿èª"}, {p: "Page 2", w: "proposal", d: "ææ¡ˆ *prop æ”¯æŒ"},
        {p: "Page 3", w: "fortunate", d: "å¹¸é‹"}, {p: "Page 3", w: "advance", d: "å‰é€²/äº‹å…ˆ"}, {p: "Page 3", w: "in advance", d: "æå‰"}, {p: "Page 3", w: "reservation", d: "é ç´„"}, {p: "Page 3", w: "advantage", d: "å„ªå‹¢"}, {p: "Page 3", w: "factory", d: "å·¥å» "}, {p: "Page 3", w: "technology", d: "æŠ€è¡“"}, {p: "Page 3", w: "expand", d: "æ“´å¤§"}, {p: "Page 3", w: "advertise", d: "å®£å‚³ã€é€šçŸ¥ *announce"}, {p: "Page 3", w: "hiring", d: "åƒ±ç”¨"}, {p: "Page 3", w: "advertisement", d: "å»£å‘Š"}, {p: "Page 3", w: "glance", d: "æƒè¦–"}, {p: "Page 3", w: "advice ", d: "å»ºè­°"}, {p: "Page 3", w: "advise ", d: "å‹¸å‘Š"}, {p: "Page 3", w: "resignation", d: "è¾­è·"}, {p: "Page 3", w: "affair", d: "äº‹æƒ…"}, {p: "Page 3", w: "influence", d: "å½±éŸ¿"}, {p: "Page 3", w: "reputation", d: "ä¿¡è­½"}, {p: "Page 3", w: "colleague", d: "åŒäº‹"}, {p: "Page 3", w: "afterward", d: "ä¹‹å¾Œ"}, {p: "Page 3", w: "folder", d: "è³‡æ–™å¤¾"}, {p: "Page 3", w: "cabinet", d: "æ«ƒå­"}, {p: "Page 3", w: "against", d: "åå° *versus"}, {p: "Page 3", w: "purchase", d: "è³¼è²·"}, {p: "Page 3", w: "contract", d: "åˆç´„"}, {p: "Page 3", w: "negotiator", d: "è«‡åˆ¤äºº"}, {p: "Page 3", w: "agreement", d: "å”è­°"}, {p: "Page 3", w: "trade", d: "è²¿æ˜“"},
        {p: "Page 5", w: "resume", d: "å±¥æ­·è¡¨"}, {p: "Page 5", w: "opening", d: "ç©ºç¼º"}, {p: "Page 5", w: "injury", d: "å‚·å®³"}, {p: "Page 5", w: "submit", d: "æäº¤"}, {p: "Page 5", w: "requirement", d: "è¦æ±‚"}, {p: "Page 5", w: "meet", d: "æ»¿è¶³"}, {p: "Page 5", w: "qualified", d: "åˆæ ¼çš„"}, {p: "Page 5", w: "candidate", d: "å€™é¸è€…"}, {p: "Page 5", w: "confidence", d: "è‡ªä¿¡"}, {p: "Page 5", w: "professional", d: "å°ˆå®¶"}, {p: "Page 5", w: "profession", d: "è·æ¥­"}, {p: "Page 5", w: "hire", d: "é›‡ç”¨"}, {p: "Page 5", w: "training", d: "è¨“ç·´"}, {p: "Page 5", w: "reference", d: "åƒè€ƒ"}, {p: "Page 5", w: "position", d: "è·ä½ / ä½ç½®"}, {p: "Page 5", w: "impressed", d: "æ„Ÿåˆ°å°è±¡æ·±åˆ»çš„"}, {p: "Page 5", w: "impressive", d: "çµ¦äººå°è±¡æ·±åˆ»çš„"}, {p: "Page 5", w: "eligible", d: "åˆé©çš„"}, {p: "Page 5", w: "identify", d: "è­˜åˆ¥"}, {p: "Page 5", w: "associate", d: "è¯æƒ³"}, {p: "Page 5", w: "condition", d: "æ¢ä»¶"}, {p: "Page 5", w: "employment", d: "åƒ±ç”¨"}, {p: "Page 5", w: "managerial", d: "ç®¡ç†çš„"}, {p: "Page 5", w: "diligent", d: "å‹¤å¥®çš„"}, {p: "Page 5", w: "familiar (with)", d: "ç†Ÿæ‚‰çš„"}, {p: "Page 5", w: "proficiency", d: "ç†Ÿç·´"}, {p: "Page 5", w: "prospective", d: "é æœŸçš„"}, {p: "Page 5", w: "appeal (to)", d: "å¸å¼•"}, {p: "Page 5", w: "specialize", d: "å°ˆæ”»"}, {p: "Page 5", w: "apprehensive", d: "æ“”æ†‚çš„"}, {p: "Page 5", w: "consultant", d: "é¡§å•"}, {p: "Page 5", w: "consultation", d: "è«®è©¢"}, {p: "Page 5", w: "entitle", d: "çµ¦äºˆæ¬Šåˆ©"}, {p: "Page 5", w: "degree", d: "å­¸ä½"}, {p: "Page 5", w: "payroll", d: "è–ªæ°´åå†Š"},
        {p: "Page 6", w: "recruit", d: "æ‹›å‹Ÿ"}, {p: "Page 6", w: "certification", d: "è­‰æ˜"}, {p: "Page 6", w: "certificate", d: "è­‰æ›¸"}, {p: "Page 6", w: "occupation", d: "è·æ¥­"}, {p: "Page 6", w: "occupy", d: "ä½”æ“š"}, {p: "Page 6", w: "wage", d: "å·¥è³‡"}, {p: "Page 6", w: "fair", d: "å…¬å¹³çš„"}, {p: "Page 6", w: "graduation", d: "ç•¢æ¥­"}, {p: "Page 6", w: "part-time", d: "å…¼è·"}, {p: "Page 6", w: "tidy", d: "æ•´é½Šçš„"}, {p: "Page 6", w: "trainee", d: "å—è¨“è€…"}, {p: "Page 6", w: "aptitude", d: "è³‡è³ª"}, {p: "Page 6", w: "be admitted to", d: "è¢«å…è¨±é€²å…¥"}, {p: "Page 6", w: "be advised to do", d: "è¢«å»ºè­°åš"}, {p: "Page 6", w: "criteria", d: "æ¨™æº–"}, {p: "Page 6", w: "standard", d: "æ¨™æº–"}, {p: "Page 6", w: "attire", d: "æœè£"}, {p: "Page 6", w: "code", d: "è¦ç¯„"}, {p: "Page 6", w: "policy", d: "æ”¿ç­–"}, {p: "Page 6", w: "comply", d: "éµå®ˆ"}, {p: "Page 6", w: "regulation", d: "è¦å®š"}, {p: "Page 6", w: "adhere", d: "å …æŒ"}, {p: "Page 6", w: "severely", d: "åš´é‡åœ°"}, {p: "Page 6", w: "refrain", d: "å…‹åˆ¶"}, {p: "Page 6", w: "permission", d: "è¨±å¯"}, {p: "Page 6", w: "access", d: "ä½¿ç”¨æ¬Š"}, {p: "Page 6", w: "thoroughly", d: "å¾¹åº•åœ°"}, {p: "Page 6", w: "revise", d: "ä¿®è¨‚"}, {p: "Page 6", w: "approach", d: "æ–¹æ³•ã€æ¥è¿‘"}, {p: "Page 6", w: "approval", d: "æ‰¹å‡†"}, {p: "Page 6", w: "form", d: "è¡¨æ ¼"}, {p: "Page 6", w: "immediately", d: "ç«‹å³"}, {p: "Page 6", w: "inspection", d: "æª¢æŸ¥"},
        {p: "Page 7", w: "arrangement", d: "å®‰æ’"}, {p: "Page 7", w: "procedure", d: "æ‰‹çºŒ"}, {p: "Page 7", w: "proceed", d: "é€²å±•"}, {p: "Page 7", w: "negative", d: "è² é¢çš„"}, {p: "Page 7", w: "mandate", d: "æˆæ¬Š"}, {p: "Page 7", w: "drastically", d: "åŠ‡çƒˆåœ°"}, {p: "Page 7", w: "according to", d: "æ ¹æ“š"}, {p: "Page 7", w: "constant", d: "æŒçºŒçš„"}, {p: "Page 7", w: "compensation", d: "è£œå„Ÿ"}, {p: "Page 7", w: "obligation", d: "ç¾©å‹™"}, {p: "Page 7", w: "authorize", d: "æ‰¹å‡†"}, {p: "Page 7", w: "prohibit", d: "ç¦æ­¢"}, {p: "Page 7", w: "abolish", d: "å»¢é™¤"}, {p: "Page 7", w: "enforce", d: "åŸ·è¡Œ"}, {p: "Page 7", w: "legislation", d: "æ³•å¾‹"}, {p: "Page 7", w: "restrict", d: "é™åˆ¶"}, {p: "Page 7", w: "limit", d: "é™åˆ¶"}, {p: "Page 7", w: "bend over", d: "å½è…°"}, {p: "Page 7", w: "used to", d: "éå»ç¿’æ…£"}, {p: "Page 7", w: "get used to N/Ving", d: "æ¼¸æ¼¸ç¿’æ…£"}, {p: "Page 7", w: "be used to Ving", d: "ç¾åœ¨ç¿’æ…£"}, {p: "Page 7", w: "curriculum", d: "èª²ç¨‹"}, {p: "Page 7", w: "protect", d: "ä¿è­·"}, {p: "Page 7", w: "theft", d: "ç›œç«Š"}, {p: "Page 7", w: "witness", d: "ç›®æ“Šè€…"}
    ];

    let fullData = [];
    let customData = [];
    let currentFiltered = [];
    let wrongAnswers = new Set();
    
    // é€²åº¦è¨˜æ†¶è®Šæ•¸
    let currentIndex = 0;
    let learnFlipped = false;
    let currentSpellIndex = 0;
    
    // éŸ³æ•ˆ
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        if (type === 'success') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.3);
        } else {
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.4);
        }
    }
function playSound(text) {
  if (!text) return;

  speechSynthesis.cancel();

  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = 'en-US';

  // ğŸ”‘ è‹±æ–‡å­¸ç¿’æœ€ä½³è¨­å®š
  msg.rate = 0.85;   // æ¯”æ­£å¸¸æ…¢ä¸€é»ï¼Œå­éŸ³æ¸…æ¥š
  msg.pitch = 1.0;   // æ¨™æº–éŸ³é«˜ï¼Œä¸è¦è®Šè²

  if (STANDARD_VOICE) {
    msg.voice = STANDARD_VOICE;
  }

  speechSynthesis.speak(msg);
}


    // åˆå§‹åŒ–
    window.onload = () => {
        loadData();
        loadSavedState();
        
        document.getElementById("spell-input").addEventListener("keypress", function(event) {
            if (event.key === "Enter") checkSpelling();
        });
        document.getElementById("new-word").addEventListener("keypress", function(event) {
            if (event.key === "Enter") document.getElementById("new-def").focus();
        });
        document.getElementById("new-def").addEventListener("keypress", function(event) {
            if (event.key === "Enter") addCustomWord();
        });
    };

function loadData() {
    // âœ… è®€å–æ¨™è¨˜å–®å­—
    const storedMarked = localStorage.getItem('markedWords');
    markedSet = storedMarked ? new Set(JSON.parse(storedMarked)) : new Set();

    const stored = localStorage.getItem('customVocab');
    customData = stored ? JSON.parse(stored) : [];

    const formattedCustom = customData.map(i => ({
        ...i,
        p: i.cat || "custom",
        isCustom: true,
        marked: markedSet.has(i.w)
    }));

    fullData = [...formattedCustom, ...defaultData].map(item => ({
        ...item,
        marked: markedSet.has(item.w),
        isCustom: item.isCustom || false
    }));
}

    // --- ç‹€æ…‹å­˜å–åŠŸèƒ½ ---
    function saveState() {
        const state = {
            filter: document.getElementById('page-filter').value,
            mode: document.querySelector('.tab-btn.active') ? document.querySelector('.tab-btn.active').id : 'tab-list',
            cardIdx: currentIndex,
            spellIdx: currentSpellIndex,
            spellMode: spellMode
        };
        localStorage.setItem('appState', JSON.stringify(state));
    }

    function loadSavedState() {
        const saved = localStorage.getItem('appState');
        if (saved) {
            const state = JSON.parse(saved);
            document.getElementById('page-filter').value = state.filter;
            filterData(false);
            
            currentIndex = (state.cardIdx < currentFiltered.length) ? state.cardIdx : 0;
            currentSpellIndex = (state.spellIdx < currentFiltered.length) ? state.spellIdx : 0;
            
            spellMode = state.spellMode || 'hard';
            document.querySelector(`input[name="spellMode"][value="${spellMode}"]`).checked = true;

            if (state.mode) {
                const btn = document.getElementById(state.mode);
                if (btn) btn.click();
            } else {
                switchMode('list');
            }
        } else {
            filterData();
            switchMode('list');
        }
        updateCard();
        updateLearningCard();
        updateJumpMenus();
        if(document.getElementById('spelling-view').style.display === 'block') loadSpellingWord();
    }

    function switchMode(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const btnId = 'tab-' + mode;
        const btn = document.getElementById(btnId);
        if(btn) btn.classList.add('active');
        
        ['list-view', 'learning-view', 'flashcard-view', 'quiz-view', 'spelling-view', 'manage-view'].forEach(id => 
            document.getElementById(id).style.display = 'none'
        );
        document.getElementById('filter-bar').style.display = (mode === 'manage') ? 'none' : 'flex';

        if (mode === 'list') { document.getElementById('list-view').style.display = 'grid'; renderList(); }
        else if (mode === 'learning') { document.getElementById('learning-view').style.display = 'block'; updateLearningCard(); updateJumpMenus(); }
        else if (mode === 'flashcard') { document.getElementById('flashcard-view').style.display = 'block'; updateCard(); updateJumpMenus(); }
        else if (mode === 'quiz') { 
    document.getElementById('quiz-view').style.display = 'block'; 
    startQuizRound(); 
}

        else if (mode === 'spelling') { document.getElementById('spelling-view').style.display = 'block'; loadSpellingWord(); updateJumpMenus(); }
        else if (mode === 'manage') { document.getElementById('manage-view').style.display = 'block'; }
        
        saveState();
    }

    function filterData(resetIndex = true) {
        const filter = document.getElementById('page-filter').value;
        if (filter === 'all') currentFiltered = fullData;
        else if (filter === 'marked') currentFiltered = fullData.filter(i => i.marked);
        else if (filter === 'wrong') currentFiltered = Array.from(wrongAnswers);
        else if (filter === 'custom') currentFiltered = fullData.filter(i => i.isCustom);
        else currentFiltered = fullData.filter(i => i.p === filter);
        
        if (resetIndex) {
            currentIndex = 0;
            currentSpellIndex = 0;
        }
        
        document.getElementById('stats-info').innerText = `å…± ${currentFiltered.length} å€‹å–®å­—`;
        if(document.getElementById('list-view').style.display !== 'none') renderList();
        
        updateJumpMenus();
        saveState();
    }

    // --- è·³è½‰é¸å–®é‚è¼¯ ---
    function updateJumpMenus() {
        setupJumpMenu('learning-jump', currentIndex, (val) => jumpToCard(val));
        setupJumpMenu('flashcard-jump', currentIndex, (val) => jumpToCard(val));
        setupJumpMenu('spelling-jump', currentSpellIndex, (val) => jumpToSpelling(val));
    }

    function setupJumpMenu(id, activeIndex, callback) {
        const select = document.getElementById(id);
        if (!select) return;

        const render = (showEnglish) => {
            if (currentFiltered.length === 0) {
                select.innerHTML = '<option>ç„¡å–®å­—</option>';
                return;
            }
            select.innerHTML = currentFiltered.map((item, idx) => {
                const text = showEnglish ? `${idx + 1}. ${item.w}` : `ç¬¬ ${idx + 1} å€‹å–®å­—`;
                return `<option value="${idx}" ${idx === activeIndex ? 'selected' : ''}>${text}</option>`;
            }).join('');
        };
        render(false);
        select.onfocus = () => render(true);
        select.onblur = () => render(false);
        select.onchange = (e) => { callback(e.target.value); render(false); select.blur(); };
        select.onmousedown = () => render(true);
    }

    function jumpToCard(val) {
        currentIndex = parseInt(val);
        updateCard();
        updateLearningCard();
        saveState();
    }
    function jumpToSpelling(val) {
        currentSpellIndex = parseInt(val);
        loadSpellingWord();
        saveState();
    }

    // --- åˆ—è¡¨åŠŸèƒ½ ---
    function renderList() {
        const container = document.getElementById('list-view');
        if (currentFiltered.length === 0) { container.innerHTML = "<p style='grid-column:1/-1; text-align:center; padding:20px;'>æ²’æœ‰ç¬¦åˆçš„å–®å­—</p>"; return; }
        container.innerHTML = currentFiltered.map((item) => {
            const originalIndex = fullData.indexOf(item);
            return `
            <div class="vocab-item ${item.marked ? 'marked' : ''} ${item.isCustom ? 'custom' : ''}">
                <div class="word-info">
                    <b>${item.w} ${item.isCustom ? '<span style="font-size:12px; color:#9b59b6;">(è‡ªè¨‚)</span>' : ''}</b>
                    <span>${item.d}</span>
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    ${item.isCustom ? `<span class="del-btn" onclick="deleteCustomWord('${item.w}')">åˆªé™¤</span>` : ''}
                    <button class="star-btn" onclick="toggleMark(${originalIndex})">${item.marked ? 'â˜…' : 'â˜†'}</button>
                    <button style="background:#e1f0ff; border:none; padding:8px; border-radius:50%; cursor:pointer;" onclick="playSound('${item.w}')">ğŸ”Š</button>
                </div>
            </div>
        `}).join('');
    }
    function toggleMark(index) {
    const item = fullData[index];
    item.marked = !item.marked;

    if (item.marked) {
        markedSet.add(item.w);
    } else {
        markedSet.delete(item.w);
    }

    // âœ… å­˜é€² localStorage
    localStorage.setItem('markedWords', JSON.stringify([...markedSet]));

    renderList();
    saveState();
}

    // --- ç®¡ç†åŠŸèƒ½ ---
    function addCustomWord() {
        const wInput = document.getElementById('new-word');
        const dInput = document.getElementById('new-def');
        const w = wInput.value.trim();
        const d = dInput.value.trim();
        if(!w || !d) { alert("è«‹è¼¸å…¥è‹±æ–‡å–®å­—èˆ‡ä¸­æ–‡è§£é‡‹"); return; }
        if(fullData.some(i => i.w.toLowerCase() === w.toLowerCase())) { alert("é€™å€‹å–®å­—å·²ç¶“å­˜åœ¨å›‰ï¼"); return; }
        const newItem = { p: "custom", w: w, d: d };
        customData.push(newItem);
        localStorage.setItem('customVocab', JSON.stringify(customData));
        wInput.value = ''; dInput.value = ''; wInput.focus();
        loadData(); renderCustomList(); filterData(false); alert(`æˆåŠŸåŠ å…¥: ${w}`);
    }
    function batchImport() {
        const text = document.getElementById('bulk-input').value;
        if (!text.trim()) { alert("è«‹è¼¸å…¥å…§å®¹"); return; }
        const lines = text.split('\n');
        let addedCount = 0;
        lines.forEach(line => {
            line = line.trim().replace(/^[â€¢\-\*0-9\.]+\s*/, '');
            const match = line.match(/^([a-zA-Z\s\-\/\(\)]+?)[\s\t\:\-]+(.+)$/);
            if (match && match[1] && match[2]) {
                const w = match[1].trim();
                const d = match[2].trim();
                if (!fullData.some(i => i.w.toLowerCase() === w.toLowerCase())) {
                    customData.push({ p: "custom", w: w, d: d });
                    addedCount++;
                }
            }
        });
        if (addedCount > 0) {
            localStorage.setItem('customVocab', JSON.stringify(customData));
            loadData(); renderCustomList(); document.getElementById('bulk-input').value = ''; 
            filterData(false); alert(`æˆåŠŸåŒ¯å…¥ ${addedCount} å€‹å–®å­—ï¼`);
        } else { alert("æ²’æœ‰åŒ¯å…¥ä»»ä½•å–®å­—"); }
    }
    function renderCustomList() {
        const list = document.getElementById('custom-word-list');
        if(customData.length === 0) { list.innerHTML = "<p style='color:#999; text-align:center;'>ç›®å‰æ²’æœ‰è‡ªè¨‚å–®å­—</p>"; return; }
        list.innerHTML = customData.map(i => `
            <div class="custom-item"><div><b>${i.w}</b> <span style="color:#666;">${i.d}</span></div><button onclick="deleteCustomWord('${i.w}')" style="background:none; border:none; color:#e74c3c; cursor:pointer;">ğŸ—‘ï¸</button></div>
        `).join('');
    }
    function deleteCustomWord(word) {
        if(!confirm(`ç¢ºå®šè¦åˆªé™¤ "${word}" å—ï¼Ÿ`)) return;
        customData = customData.filter(i => i.w !== word);
        localStorage.setItem('customVocab', JSON.stringify(customData));
        loadData(); renderCustomList(); filterData(false);
    }
    function clearCustomWords() {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ‚¨æ–°å¢çš„å–®å­—å—ï¼Ÿ")) return;
        localStorage.removeItem('customVocab');
        customData = [];
        loadData(); renderCustomList(); filterData(false); alert("å·²æ¸…é™¤");
    }

    // --- å–®å­—å¡ (å­¸ç¿’æ¨¡å¼) ---
    function updateLearningCard() {
        if (currentFiltered.length === 0) return;
        const card = currentFiltered[currentIndex];
        document.getElementById('learn-word').innerText = card.w;
        document.getElementById('learn-def').innerText = card.d;
        document.getElementById('learn-progress').innerText = `${currentIndex + 1} / ${currentFiltered.length}`;
        const starBtn = document.getElementById('learn-star-btn');
        starBtn.innerText = card.marked ? 'â˜…' : 'â˜†';
        const cardContainer = document.getElementById('learn-card-container');
        if(card.marked) cardContainer.classList.add('marked'); else cardContainer.classList.remove('marked');
        updateJumpMenus();
        setLearnFlip(false);
    }

    function toggleMarkCurrent() {
        if (currentFiltered.length === 0) return;
        const item = currentFiltered[currentIndex];
        const originalIndex = fullData.indexOf(item);
        toggleMark(originalIndex);
        updateLearningCard();
    }

    function setLearnFlip(isFlip) {
    learnFlipped = isFlip;
    const flipEl = document.getElementById('learn-flip');
    if (!flipEl) return;
    if (learnFlipped) flipEl.classList.add('flipped');
    else flipEl.classList.remove('flipped');
}

function toggleLearnFlip() {
    setLearnFlip(!learnFlipped);
}

    // --- ç™¼éŸ³å¡ç‰‡ ---
    function updateCard() {
        if (currentFiltered.length === 0) return;
        const card = currentFiltered[currentIndex];
        document.getElementById('card-word').innerText = card.w;
        document.getElementById('card-def-hint').innerText = card.d;
        document.getElementById('card-def').innerText = card.d;
        document.getElementById('main-card').classList.remove('flipped');
        document.getElementById('card-progress').innerText = `${currentIndex + 1} / ${currentFiltered.length}`;
        updateJumpMenus();
    }
    function nextCard() { currentIndex = (currentIndex + 1) % currentFiltered.length; updateCard(); updateLearningCard(); saveState(); }
    function prevCard() { currentIndex = (currentIndex - 1 + currentFiltered.length) % currentFiltered.length; updateCard(); updateLearningCard(); saveState(); }
    function speakCurrentCard() { playSound(currentFiltered[currentIndex].w); }

// --- èªéŸ³è¾¨è­˜ (ç²¾æº–ä¸”ç©©å®šç‰ˆ) ---
const recognition = window.SpeechRecognition || window.webkitSpeechRecognition ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;

if (recognition) { 
    recognition.lang = 'en-US'; 
    recognition.interimResults = false; 
    // è¨­å®šç‚º 1ï¼Œåªå–æœ€æº–ç¢ºçš„é‚£ä¸€å€‹çµæœ
    recognition.maxAlternatives = 1; 
}

function startRecognition() {
    if (!recognition || currentFiltered.length === 0) {
        alert("ç„¡æ³•å•Ÿå‹•èªéŸ³è¾¨è­˜ã€‚");
        return;
    }

    const micBtn = document.getElementById('mic-btn');
    const feedback = document.getElementById('speech-feedback');
    
    // 1. åš´æ ¼æ¸…ç†ç›®æ¨™å–®å­—ï¼šè½‰å°å¯«ã€å»å‰å¾Œç©ºæ ¼ã€å»é™¤éè‹±æ–‡å­—å…ƒ
    const rawTarget = currentFiltered[currentIndex].w.toLowerCase();
    const validTargets = rawTarget.split(/[\/,\(\)]/)
        .map(t => t.trim().toLowerCase().replace(/[^a-z0-9\s]/g, ''))
        .filter(t => t.length > 0);

    micBtn.classList.add('recording'); 
    feedback.innerText = "ğŸ‘‚ è†è½ä¸­...";
    
    try {
        recognition.start();
    } catch(e) {
        console.error("Recognition already started");
    }

    recognition.onresult = (e) => {
        // å–å¾—è¾¨è­˜çµæœ
        const result = e.results[0][0]; 
        // 2. åš´æ ¼æ¸…ç†è¾¨è­˜å‡ºçš„æ–‡å­—
        const spoken = result.transcript.toLowerCase().trim().replace(/[^a-z0-9\s]/g, '');
        
        console.log("è¾¨è­˜åˆ°:", spoken);
        console.log("ç›®æ¨™æ¸…å–®:", validTargets);

        let isCorrect = false;

        // 3. åŸ·è¡Œå®Œå…¨å»åˆæ¯”å°
        for (let target of validTargets) {
            if (spoken === target) {
                isCorrect = true;
                break;
            }
        }

        // 4. é¡¯ç¤ºçµæœ
        if (isCorrect) {
            feedback.innerHTML = `âœ… æ­£ç¢ºï¼<br><span style="font-size:12px; color:#888;">(è¾¨è­˜ç‚º: ${spoken})</span>`;
            feedback.style.color = "var(--success)";
            if (typeof playBeep === 'function') playBeep('success');
        } else {
            // å¦‚æœä¸æ­£ç¢ºï¼Œé¡¯ç¤ºè¾¨è­˜åˆ°çš„å­—ä¾›ä½¿ç”¨è€…åƒè€ƒ
            feedback.innerHTML = `âŒ è½èµ·ä¾†åƒ: "${spoken}"<br><span style="font-size:12px;">è«‹å†è©¦ä¸€æ¬¡</span>`;
            feedback.style.color = "var(--danger)";
            if (typeof playBeep === 'function') playBeep('error');
            if (typeof wrongAnswers !== 'undefined') wrongAnswers.add(currentFiltered[currentIndex]);
        }
        micBtn.classList.remove('recording');
    };

    recognition.onerror = (event) => {
        micBtn.classList.remove('recording');
        if (event.error === 'no-speech') {
            feedback.innerText = "ğŸ”‡ æ²’è½åˆ°è²éŸ³ï¼Œè«‹é‡è©¦";
        } else {
            feedback.innerText = "âš ï¸ è¾¨è­˜å¤±æ•—: " + event.error;
        }
    };

    recognition.onend = () => micBtn.classList.remove('recording');
}

// --- æ¸¬é©—ï¼ˆä¸é‡è¤‡å‡ºé¡Œ + å‡ºå®ŒçµæŸ + é¡¯ç¤ºç­”éŒ¯é¡Œç›®ï¼‰ ---
let currentQuizItem = null;

// é¡Œåº«ï¼ˆæœ¬è¼ªé‚„æ²’å‡ºéçš„é¡Œï¼‰
let quizPool = [];
let quizTotal = 0;
let quizCorrect = 0;
let quizWrong = 0;
let quizWrongList = []; // [{w,d}...]

function shuffleArray(arr) {
    // Fisher-Yates shuffle
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function startQuizRound() {
    // ä¾ç…§ç›®å‰ç¯©é¸ç¯„åœ currentFiltered é–‹æ–°çš„ä¸€è¼ª
    quizPool = shuffleArray([...currentFiltered]); // è¤‡è£½ä¸€ä»½ï¼Œä¸å‹•åˆ°åŸé™£åˆ—
    quizTotal = quizPool.length;
    quizCorrect = 0;
    quizWrong = 0;
    quizWrongList = [];
    currentQuizItem = null;

    // UI æ¸…ç©º
    document.getElementById('quiz-feedback').innerText = "";
    document.getElementById('next-quiz-btn').classList.add('hidden');

    nextQuiz();
}

function renderQuizEnd() {
    const qText = document.getElementById('q-text');
    const qOptions = document.getElementById('q-options');
    const feedback = document.getElementById('quiz-feedback');

    qText.innerText = "âœ… æ¸¬é©—çµæŸï¼";
    qOptions.innerHTML = "";

    const wrongHtml = quizWrongList.length
        ? `<div style="text-align:left; margin-top:12px; line-height:1.6;">
             <b>âŒ ç­”éŒ¯é¡Œç›®ï¼ˆ${quizWrongList.length}ï¼‰</b><br>
             ${quizWrongList.map((x, i) => `${i + 1}. <b>${x.w}</b> â€” ${x.d}`).join("<br>")}
           </div>`
        : `<div style="margin-top:12px;"><b>å¤ªå¼·äº†ï¼æœ¬è¼ªå…¨å° ğŸ‰</b></div>`;

    feedback.innerHTML = `
        <div style="font-size:16px; color:#333;">
            ç¸½é¡Œæ•¸ï¼š${quizTotal}ã€€âœ…ç­”å°ï¼š${quizCorrect}ã€€âŒç­”éŒ¯ï¼š${quizWrong}
        </div>
        ${wrongHtml}
        <div style="margin-top:16px;">
            <button class="nav-btn" style="background:var(--primary); color:white; border:none;"
                onclick="startQuizRound()">å†æ¸¬ä¸€æ¬¡ï¼ˆåŒç¯„åœï¼‰</button>
        </div>
    `;
}

function nextQuiz() {
    // é¡Œé‡ä¸è¶³ (éœ€4å€‹) â€” ä»ä¿ç•™åŸé‚è¼¯
    if (currentFiltered.length < 4) {
        document.getElementById('q-text').innerText = "å–®å­—é‡ä¸è¶³ (éœ€4å€‹)";
        document.getElementById('q-options').innerHTML = "";
        document.getElementById('quiz-feedback').innerText = "";
        document.getElementById('next-quiz-btn').classList.add('hidden');
        return;
    }

    // å¦‚æœé¡Œåº«é‚„æ²’å»ºç«‹/æˆ–ç¯„åœæ”¹äº†ï¼Œé‡æ–°é–‹å§‹ä¸€è¼ª
    if (!quizPool || quizPool.length === 0 && quizTotal === 0) {
        startQuizRound();
        return;
    }

    // é¡Œåº«å‡ºå®Œï¼šçµæŸ
    if (quizPool.length === 0) {
        renderQuizEnd();
        return;
    }

    // UI reset
    document.getElementById('next-quiz-btn').classList.add('hidden');
    document.getElementById('quiz-feedback').innerText = "";
    document.getElementById('q-options').innerHTML = "";

    // å–å‡ºä¸‹ä¸€é¡Œï¼ˆä¸æ”¾å›ï¼Œæ‰€ä»¥ä¸é‡è¤‡ï¼‰
    currentQuizItem = quizPool.shift();

    // é¸é …ï¼šæ­£ç¢º + 3 å€‹å¹²æ“¾ï¼ˆå¾ currentFiltered æŠ½ï¼Œä¸å¯é‡è¤‡ï¼‰
    const options = [currentQuizItem];
    while (options.length < 4) {
        const r = currentFiltered[Math.floor(Math.random() * currentFiltered.length)];
        if (!options.includes(r)) options.push(r);
    }
    options.sort(() => Math.random() - 0.5);

    document.getElementById('q-text').innerText = currentQuizItem.w;
    document.getElementById('q-options').innerHTML = options
        .map(opt => `<button class="option-btn" onclick="checkAnswer(this, '${opt.w.replace(/'/g, "\\'")}')">${opt.d}</button>`)
        .join('');
}

function checkAnswer(btn, word) {
    // ç¦ç”¨å…¨éƒ¨é¸é …
    document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

    if (word === currentQuizItem.w) {
        btn.classList.add('correct');
        playBeep('success');
        quizCorrect++;
        document.getElementById('quiz-feedback').innerText = "ğŸ‰ ç­”å°äº†ï¼";
    } else {
        btn.classList.add('wrong');
        playBeep('error');
        quizWrong++;

        // åŠ å…¥ã€Œç­”éŒ¯ã€é›†åˆï¼ˆä½ åŸæœ¬çš„åŠŸèƒ½ï¼‰
        wrongAnswers.add(currentQuizItem);

        // è¨˜éŒ„ç­”éŒ¯æ¸…å–®ï¼ˆé¿å…é‡è¤‡åˆ—åŒä¸€é¡Œï¼‰
        if (!quizWrongList.some(x => x.w === currentQuizItem.w)) {
            quizWrongList.push({ w: currentQuizItem.w, d: currentQuizItem.d });
        }

        document.getElementById('quiz-feedback').innerText = `âš ï¸ æ­£ç¢ºæ˜¯ï¼š${currentQuizItem.d}`;

        // æŠŠæ­£ç¢ºé¸é …æ¨™ç¶ 
        document.querySelectorAll('.option-btn').forEach(b => {
            if (b.innerText === currentQuizItem.d) b.classList.add('correct');
        });
    }

    // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•ï¼ˆé¡Œåº«æ²’äº†å°±é¡¯ç¤ºã€ŒçµæŸã€ï¼‰
    const nextBtn = document.getElementById('next-quiz-btn');
    nextBtn.classList.remove('hidden');
    nextBtn.innerText = (quizPool.length === 0) ? "çœ‹çµæœ âœ…" : "ä¸‹ä¸€é¡Œ â¡ï¸";
}


    // --- æ‹¼å­— ---
    let spellMode = 'hard';
    function initSpelling() { currentSpellIndex = 0; loadSpellingWord(); }
    function changeSpellMode(mode) { spellMode = mode; loadSpellingWord(); saveState(); }
    function loadSpellingWord() {
    if(currentFiltered.length === 0) {
        document.getElementById('spell-display-area').innerHTML = "ç„¡å–®å­—å¯ç·´ç¿’";
        return;
    }
    const input = document.getElementById('spell-input');
    input.value = "";
    input.classList.remove('correct', 'wrong');
    input.disabled = false;
    input.focus();

    document.getElementById('spell-feedback').innerText = "";
    const item = currentFiltered[currentSpellIndex];
    const displayArea = document.getElementById('spell-display-area');

    if (spellMode === 'hard') {
        displayArea.innerHTML = `<p class="hint-def">${item.d}</p>`;
    } else {
        displayArea.innerHTML = `<p class="hint-word">${item.w}</p><p class="hint-sub">${item.d}</p>`;
    }
    updateJumpMenus();
}

function checkSpelling() {
    const input = document.getElementById('spell-input');
    const ans = input.value.trim().toLowerCase();
    const correct = currentFiltered[currentSpellIndex].w.toLowerCase();

    if (ans === correct) {
        input.classList.add('correct');
        document.getElementById('spell-feedback').innerText = "âœ… æ­£ç¢ºï¼";
        playBeep('success');
        playSound(correct);
        input.disabled = true;

        setTimeout(() => {
            currentSpellIndex = (currentSpellIndex + 1) % currentFiltered.length;
            loadSpellingWord();
            saveState();
        }, 1200);
    } else {
        input.classList.add('wrong');
        playBeep('error');
        wrongAnswers.add(currentFiltered[currentSpellIndex]);
        setTimeout(() => input.classList.remove('wrong'), 500);
    }
}

function skipSpelling() {
    const correct = currentFiltered[currentSpellIndex].w;
    document.getElementById('spell-input').value = correct;
    playSound(correct);

    setTimeout(() => {
        currentSpellIndex = (currentSpellIndex + 1) % currentFiltered.length;
        loadSpellingWord();
        saveState();
    }, 1000);
}

function speakCurrentSpellWord() {
    playSound(currentFiltered[currentSpellIndex].w);
}

/* =========================================================
   âœ… Space = ç™¼éŸ³
   âœ… â† / â†’ = ä¸Šä¸€å€‹ / ä¸‹ä¸€å€‹
   ï¼ˆåªåœ¨ learning / flashcard / spelling ç”Ÿæ•ˆï¼‰
   ä¸¦ä¸”å¾¹åº•é¿å…ã€Œç©ºç™½éµè§¸ç™¼ä¸Šä¸€å€‹é»éçš„æŒ‰éˆ•ã€
========================================================= */
(function setupHotkeysFinal() {

    function getMode() {
        return document.querySelector('.tab-btn.active')?.id || '';
        // tab-learning / tab-flashcard / tab-spelling ...
    }

    function isSpace(e){ return e.code === 'Space' || e.key === ' ' || e.key === 'Spacebar'; }
    function isLeft(e){ return e.code === 'ArrowLeft' || e.key === 'ArrowLeft'; }
    function isRight(e){ return e.code === 'ArrowRight' || e.key === 'ArrowRight'; }

    function block(e){
        e.preventDefault();
        e.stopPropagation();
        if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
    }

    // è®“ä»»ä½•æŒ‰éˆ•ã€Œä¸ç•™ focusã€ï¼Œæ ¹æ²» space æœƒé‡æŒ‰ä¸Šä¸€å€‹æŒ‰éˆ•
    document.addEventListener('pointerdown', (e) => {
        const btn = e.target.closest?.('button, a');
        if (btn) btn.blur();
    }, true);

    // åªè¦ä½ åˆ‡æ›æ¨¡å¼ï¼Œä¹ŸæŠŠ focus æ¸…æ‰
    document.addEventListener('click', (e) => {
        const tab = e.target.closest?.('.tab-btn');
        if (tab) tab.blur();
    }, true);

    // âœ… ç”¨ capture æ””æˆªï¼ˆkeydown + keyup éƒ½æ””ï¼‰ï¼Œé¿å…ç€è¦½å™¨æŠŠ Space è®Š click
function handler(e){
    const mode = document.querySelector('.tab-btn.active')?.id || '';
    const inLearning = mode === 'tab-learning';
    const inFlash = mode === 'tab-flashcard';
    const inSpell = mode === 'tab-spelling';

    if (!(inLearning || inFlash || inSpell)) return;

    /* ===============================
       âœ… M éµï¼šå–®å­—å¡ç¿»å¡
    =============================== */
    const isC = e.key === 'c' || e.key === 'C';
    if (isC && inLearning) {
        // é¿å…åœ¨è¼¸å…¥æ¡†æ™‚èª¤è§¸
        const el = document.activeElement;
        const typing = el && (
            el.tagName === 'INPUT' ||
            el.tagName === 'TEXTAREA' ||
            el.isContentEditable
        );
        if (!typing) {
            e.preventDefault();
            e.stopPropagation();
            if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();

            toggleLearnFlip(); // ğŸ‘ˆ ä½ å·²ç¶“æœ‰çš„ç¿»å¡å‡½å¼
        }
        return;
    }

    /* ===== åŸæœ¬çš„ Space / â† / â†’ é‚è¼¯å…¨éƒ¨ç•™è‘— ===== */

    const isSpace = e.code === 'Space' || e.key === ' ' || e.key === 'Spacebar';
    const isLeft = e.code === 'ArrowLeft' || e.key === 'ArrowLeft';
    const isRight = e.code === 'ArrowRight' || e.key === 'ArrowRight';

    if (!(isSpace || isLeft || isRight)) return;

    // æ¸…ç„¦é»ï¼Œé¿å… Space è§¸ç™¼æŒ‰éˆ•
    if (document.activeElement && 
       (document.activeElement.tagName === 'BUTTON' || document.activeElement.tagName === 'A')) {
        document.activeElement.blur();
    }
    document.body?.focus({preventScroll:true});

    e.preventDefault();
    e.stopPropagation();
    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();

    // Spaceï¼šç™¼éŸ³
    if (isSpace) {
        if (inLearning || inFlash) speakCurrentCard();
        else speakCurrentSpellWord();
        return;
    }

    // â† â†’
    if (inLearning || inFlash) {
        if (isLeft) prevCard();
        if (isRight) nextCard();
        return;
    }

    if (inSpell) {
        if (!currentFiltered || currentFiltered.length === 0) return;
        if (isLeft) {
            currentSpellIndex = (currentSpellIndex - 1 + currentFiltered.length) % currentFiltered.length;
            loadSpellingWord();
            saveState();
        }
        if (isRight) {
            currentSpellIndex = (currentSpellIndex + 1) % currentFiltered.length;
            loadSpellingWord();
            saveState();
        }
    }
}


// âœ… keydownï¼šçœŸæ­£åŸ·è¡Œå‹•ä½œï¼ˆé¿å…å·¦å³éµè·³å…©æ¬¡ï¼‰
window.addEventListener('keydown', handler, true);

// âœ… keyupï¼šåªé˜»æ­¢ç€è¦½å™¨é è¨­ï¼ˆä¸åŸ·è¡Œ prev/next/speakï¼‰
window.addEventListener('keyup', (e) => {
    const mode = document.querySelector('.tab-btn.active')?.id || '';
    const inLearning = mode === 'tab-learning';
    const inFlash = mode === 'tab-flashcard';
    const inSpell = mode === 'tab-spelling';
    if (!(inLearning || inFlash || inSpell)) return;

    const isSpace = e.code === 'Space' || e.key === ' ' || e.key === 'Spacebar';
    const isLeft = e.code === 'ArrowLeft' || e.key === 'ArrowLeft';
    const isRight = e.code === 'ArrowRight' || e.key === 'ArrowRight';
    if (!(isSpace || isLeft || isRight)) return;

    // ç®¡ç†æ¨¡å¼/æ‰¹æ¬¡è¼¸å…¥ç­‰ä¸è¦æ“‹ï¼ˆé¿å…å½±éŸ¿æ‰“å­—ï¼‰
    const el = document.activeElement;
    const typing = el && (el.tagName === 'TEXTAREA' || el.tagName === 'SELECT' || el.isContentEditable);
    const inputTyping = el && el.tagName === 'INPUT' && el.id !== 'spell-input';
    if (typing || inputTyping) return;

    e.preventDefault();
    e.stopPropagation();
    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
}, true);


})();


</script>
</body>
</html>